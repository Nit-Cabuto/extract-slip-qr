<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Upload JPG File</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
        }

        .upload-container {
            border: 2px dashed #ccc;
            padding: 30px;
            text-align: center;
            border-radius: 8px;
        }

        input[type="file"] {
            margin: 20px 0;
        }

        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background-color: #0056b3;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        #status {
            margin-top: 20px;
            padding: 10px;
            border-radius: 4px;
        }

        .success {
            background-color: #d4edda;
            color: #155724;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
</head>

<body>

    <div class="upload-container">
        <h2>Upload Slip Bank</h2>
        <input type="file" id="fileInput" accept=".jpg,.jpeg" />
        <br>
        <button id="uploadBtn" onclick="uploadFile()">Upload</button>
        <div id="status"></div>
    </div>

    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/versions/2.22.3/sdk.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://malsup.github.io/jquery.blockUI.js"></script>

    <script>

        var profileName = null;
        var userIdLine = null;

        //const id = "2008674318-sY2GkIQE"; // -- main log in
        const id = "2008716446-QzCHty1r"; // -- log in extract slip

        const CHANNEL_ACCESS_TOKEN = "WCdLOOD1qlAkK4m5AjPCLR2c20UqYURZuki3HsxyVLesLVz0bNoBB4ndY/zu7sxA876VqvdJyC2V+Ykw4ib/Loo+rZgp8vz1v1Bn0NkDpGS2QXlZMmBQ2Nvz1sXCUjw/imsac/wXrHL9l1TpAi8cbQdB04t89/1O/w1cDnyilFU=";

        //---------------------------------------------

        async function uploadFile() {

            const fileInput = document.getElementById('fileInput');
            const statusDiv = document.getElementById('status');
            const uploadBtn = document.getElementById('uploadBtn');


            if (!fileInput.files[0]) {
                statusDiv.textContent = 'Please select a file';
                statusDiv.className = 'error';
                return;
            }

            const file = fileInput.files[0];

            if (!file.type.match('image/jpeg')) {
                statusDiv.textContent = 'Please select a JPG file';
                statusDiv.className = 'error';
                return;
            }

            const formData = new FormData();
            formData.append('file', file);
            //formData.append('filename', file.name);

            uploadBtn.disabled = true;
            statusDiv.textContent = 'Uploading...';
            statusDiv.className = '';

            try {

                $.blockUI({
                    message: '<h4>กำลังอัปโหลด...</h4>',
                    css: {
                        padding: '15px',
                        borderRadius: '8px'
                    }
                });

                statusDiv.textContent = `File uploaded successfully: ${file.name}`;
                statusDiv.className = 'success';
                fileInput.value = '';

                console.log('File ready to be sent:', file.name);

                const response = await fetch('https://developer.easyslip.com/api/v1/verify', {
                    method: 'POST',
                    headers: {
                        "Authorization": `Bearer 81cae111-e8de-4266-b21c-1aa364d0ecfb`
                    },
                    body: formData
                });

                // const response = await fetch('https://uat-webhook.ksp.kln.com/extractSlip/extractSlipFile', {
                //     method: 'POST',
                //     body: formData
                // });

                console.log(response);

                console.log(response.status);

                if (response.status !== 200) {

                    $.unblockUI();

                    await liff.sendMessages([
                        {
                            type: "text",
                            text: "Read QR สลิปไม่สำเร็จ \nกรุณาอติดต่อผู IT Support",
                        }
                    ]);

                    liff.closeWindow();

                    return;
                }

                const resultData = await response.json();

                // --------------------------------------------
                var dataName = resultData.data
                console.log(dataName);

                var rec = dataName.receiver.account.name.th
                console.log("receiver : " + rec);

                if (rec.includes("KERRY")) {
                    const dataJson = { data: resultData, profileName: profileName, userIdLine: userIdLine };

                    console.log(dataJson);

                    if (resultData.status === 200) {
                        //console.log(data.data);

                        const response = await fetch('https://uat-webhook.ksp.kln.com/extractSlip/extractTextFile', {
                            //const response = await fetch('http://localhost:5270/extractSlip/extractTextFile', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(dataJson)
                            //body: resultData
                        });

                        const data = await response.json();

                        console.log(data.result);

                        sendMessageAPI(userIdLine , data);

                        // await liff.sendMessages([
                        //     {
                        //         type: "text",
                        //         text: "สลิปคุณ : "+ profileName + "\nสถานะ : " + data.result,
                        //     }
                        // ]);
                    }
                }
                else {
                    var messageError = "ชื่อในสลิปผู้รับ : " + rec + "\nไม่ตรงกับ บัญชีบริษัท ของเรา";

                    console.log(messageError);

                    await liff.sendMessages([
                        {
                            type: "text",
                            text: messageError,
                        }
                    ]);
                }
                // --------------------------------------------

                // const dataJson = { data: resultData , profileName: profileName, userIdLine: userIdLine};

                // console.log(dataJson);

                // if (resultData.status === 200)
                // {
                //     //console.log(data.data);

                //     const response = await fetch('https://uat-webhook.ksp.kln.com/extractSlip/extractTextFile', {
                //     //const response = await fetch('http://localhost:5270/extractSlip/extractTextFile', {
                //         method: 'POST',
                //         headers: {
                //             'Content-Type': 'application/json'
                //         },
                //         body: JSON.stringify(dataJson)
                //         //body: resultData
                //     });

                //     const data = await response.json();

                //     console.log(data.result);

                //     await liff.sendMessages([
                //         {
                //             type: "text",
                //             text: "สลิปคุณ : "+ profileName + "\nสถานะ : " + data.result,
                //         }
                //     ]);
                // }

                //--------------------------------------------

                // const response = await fetch('http://localhost:5228/ExtractSlip/ExtractSlipQRCodeExternal', {
                //     method: 'POST',
                //     body: formData
                // });

                // console.log(await response);

                // var data = await response.json();

                // var status = data.status;
                // console.log(status);

                // var value = data.result;
                // console.log(value.result[0]);

                // await liff.sendMessages([
                //     {
                //         type: "text",
                //         text: value.result[0],
                //     }
                // ]);


                // var message = value.result;
                // console.log(message);

                // var json = JSON.parse(message);
                // console.log(json);

                //--------------------------------------------

                // if (response.ok) {
                //     const result = await response.json();
                //     statusDiv.textContent = `File uploaded successfully: ${file.name}`;
                //     statusDiv.className = 'success';
                //     fileInput.value = '';
                //     } else {
                //         throw new Error('Upload failed');
                //     }


            } catch (error) {
                statusDiv.textContent = `Error: ${error.message}`;
                statusDiv.className = 'error';

                console.log('Error : ', error.message);

                $.unblockUI();

                await liff.sendMessages([
                    {
                        type: "text",
                        text: "ไฟล์ไม่ถูกต้อง กรุณาอัปโหลดใหม่อีกครั้ง",
                    }
                ]);
            }
            // finally 
            // {
            //         uploadBtn.disabled = false;
            // }

            // await liff.sendMessages([
            //             {
            //                 type: "text",
            //                 text: "ไฟล์ไม่ถูกต้อง กรุณาอัปโหลดใหม่อีกครั้ง",
            //             }
            // ]);
            $.unblockUI();

            liff.logout();

            console.log("Log out LIFF");

            setTimeout(() => {
                liff.closeWindow();
            }, 500);
        }

        main();

        async function main() {
            liff.init({ liffId: id }, function () {
                liff.ready.then(async () => {
                    // LIFF is ready
                    console.log('LIFF Started');

                    if (!liff.isLoggedIn()) {

                        liff.login();
                    }

                    var profile = await liff.getProfile();
                    const accessToken = await liff.getAccessToken();
                    const idToken = await liff.getIDToken();

                    console.log(profile);
                    console.log("Access Token : " + accessToken);
                    console.log("ID Token : " + idToken);

                    var name = profile.displayName;

                    console.log("Profile Name : " + profile.displayName);
                    console.log("User ID : " + profile.userId);

                    profileName = profile.displayName;
                    userIdLine = profile.userId;

                }).catch((err) => {
                    console.error('LIFF initialization failed ', err);
                });
            });
        }

        async function sendAlert() {

            await liff.sendMessages([
                {
                    type: "text",
                    text: "waiting for approve ...",
                },

                console.log("send message")
            ])
                .then(() => {
                    console.log("message sent");
                })
                .catch((err) => {
                    console.log("error", err);
                });
        }

        async function sendMessageAPI(userIdLine , data) {

            const responseData = await fetch('https://api.line.me/v2/bot/message/push', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${CHANNEL_ACCESS_TOKEN}`
                            },
                            body: JSON.stringify(
                                {
                                    "to": userIdLine,
                                    "messages": [
                                        {
                                            "type": "flex",
                                            "altText": "สลิปตรวจสอบแล้ว",
                                            "contents": {
                                                "type": "bubble",
                                                "hero": {
                                                    "type": "image",
                                                    "url": "https://cdn-icons-png.flaticon.com/512/3225/3225196.png",
                                                    "size": "md",
                                                    "aspectRatio": "1:1",
                                                    "aspectMode": "cover",
                                                    "backgroundColor": "#FFFFFF"
                                                },
                                                "body": {
                                                    "type": "box",
                                                    "layout": "vertical",
                                                    "contents": [
                                                        {
                                                            "type": "text",
                                                            "text": "สลิปตรวจสอบแล้ว ✅",
                                                            "weight": "bold",
                                                            "size": "xl",
                                                            "color": "#1B8F3A",
                                                            "align": "center"
                                                        },
                                                        {
                                                            "type": "separator",
                                                            "margin": "md"
                                                        },
                                                        {
                                                            "type": "text",
                                                            "text": data.result,
                                                            "wrap": true,
                                                            "align": "center",
                                                            "margin": "md"
                                                        }
                                                    ]
                                                },
                                                "styles": {
                                                    "body": {
                                                        "backgroundColor": "#F8FFF8"
                                                    }
                                                }
                                            }
                                        }

                                    ]
                                }
                            )
                        });

                        console.log(responseData);
        }

    </script>

</body>

</html>